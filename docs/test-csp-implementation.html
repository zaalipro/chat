<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CSP Implementation Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .test-section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success {
            border-left: 4px solid #28a745;
        }
        .warning {
            border-left: 4px solid #ffc107;
        }
        .error {
            border-left: 4px solid #dc3545;
        }
        .info {
            border-left: 4px solid #17a2b8;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
            font-weight: bold;
        }
        .status.success {
            background-color: #d4edda;
            color: #155724;
        }
        .status.warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
        }
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 4px;
        }
        .test-result.pass {
            background-color: #d4edda;
            color: #155724;
        }
        .test-result.fail {
            background-color: #f8d7da;
            color: #721c24;
        }
        .test-result.pending {
            background-color: #fff3cd;
            color: #856404;
        }
        code {
            background-color: #f8f9fa;
            padding: 2px 4px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .csp-policy {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            word-break: break-all;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #dee2e6;
        }
        .validation-score {
            font-size: 24px;
            font-weight: bold;
            text-align: center;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .score-excellent {
            background-color: #d4edda;
            color: #155724;
        }
        .score-good {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        .score-warning {
            background-color: #fff3cd;
            color: #856404;
        }
        .score-critical {
            background-color: #f8d7da;
            color: #721c24;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>üîí CSP Implementation Test</h1>
    <p>This page tests the secure Content Security Policy implementation with nonce-based approach.</p>

    <div class="test-section info">
        <h2>üìã Test Overview</h2>
        <p>This test validates that the CSP implementation:</p>
        <ul>
            <li>‚úÖ Removes unsafe <code>'unsafe-inline'</code> and <code>'unsafe-eval'</code> directives</li>
            <li>‚úÖ Implements nonce-based CSP for styled-components compatibility</li>
            <li>‚úÖ Generates secure random nonces</li>
            <li>‚úÖ Maintains functionality while improving security</li>
        </ul>
    </div>

    <div class="test-section">
        <h2>üîç CSP Policy Analysis</h2>
        <div id="csp-analysis">
            <div class="status info">Analyzing CSP policy...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üß™ Security Tests</h2>
        <div id="security-tests">
            <div class="status info">Running security tests...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>‚ö° Functionality Tests</h2>
        <div id="functionality-tests">
            <div class="status info">Testing functionality...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üìä Validation Results</h2>
        <div id="validation-results">
            <div class="status info">Validating implementation...</div>
        </div>
    </div>

    <div class="test-section">
        <h2>üéØ Interactive Tests</h2>
        <p>Click the buttons below to test specific CSP features:</p>
        <button onclick="testInlineScript()">Test Inline Script</button>
        <button onclick="testInlineStyle()">Test Inline Style</button>
        <button onclick="testEval()">Test eval()</button>
        <button onclick="testExternalResource()">Test External Resource</button>
        <button onclick="runAllTests()">Run All Tests</button>
        <div id="interactive-results"></div>
    </div>

    <div class="test-section">
        <h2>üìù Test Log</h2>
        <div id="test-log" style="max-height: 300px; overflow-y: auto; background-color: #f8f9fa; padding: 15px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px;">
            <div>Test initialized...</div>
        </div>
    </div>

    <script>
        // Test utilities
        const testLog = document.getElementById('test-log');
        const interactiveResults = document.getElementById('interactive-results');

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logEntry.style.color = type === 'error' ? '#dc3545' : type === 'warning' ? '#ffc107' : type === 'success' ? '#28a745' : '#6c757d';
            testLog.appendChild(logEntry);
            testLog.scrollTop = testLog.scrollHeight;
        }

        function showResult(containerId, message, type = 'info') {
            const container = document.getElementById(containerId);
            container.innerHTML = `<div class="status ${type}">${message}</div>`;
        }

        function addTestResult(containerId, testName, passed, message) {
            const container = document.getElementById(containerId);
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
            resultDiv.innerHTML = `
                <strong>${testName}:</strong> 
                ${passed ? '‚úÖ PASS' : '‚ùå FAIL'} 
                ${message ? `- ${message}` : ''}
            `;
            container.appendChild(resultDiv);
        }

        // CSP Analysis
        function analyzeCSP() {
            log('Starting CSP analysis...');
            
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            const nonceMeta = document.querySelector('meta[name="csp-nonce"]');
            
            if (!cspMeta) {
                showResult('csp-analysis', '‚ùå No CSP meta tag found', 'error');
                log('ERROR: No CSP meta tag found', 'error');
                return;
            }

            const cspContent = cspMeta.getAttribute('content');
            const nonce = nonceMeta ? nonceMeta.getAttribute('content') : null;

            let analysisHTML = '<div>';
            analysisHTML += `<h3>üìã CSP Policy Found</h3>`;
            analysisHTML += `<div class="csp-policy">${cspContent}</div>`;
            
            if (nonce) {
                analysisHTML += `<div class="status success">‚úÖ Nonce found: ${nonce}</div>`;
                log(`Nonce found: ${nonce}`, 'success');
            } else {
                analysisHTML += `<div class="status warning">‚ö†Ô∏è No nonce found</div>`;
                log('WARNING: No nonce found', 'warning');
            }

            // Check for unsafe directives
            const hasUnsafeInline = cspContent.includes("'unsafe-inline'");
            const hasUnsafeEval = cspContent.includes("'unsafe-eval'");
            const hasNonce = cspContent.includes("'nonce-");

            if (hasUnsafeEval) {
                analysisHTML += `<div class="status error">‚ùå Contains 'unsafe-eval' - CRITICAL SECURITY RISK</div>`;
                log('CRITICAL: CSP contains unsafe-eval', 'error');
            } else {
                analysisHTML += `<div class="status success">‚úÖ No 'unsafe-eval' found</div>`;
                log('GOOD: No unsafe-eval found', 'success');
            }

            if (hasUnsafeInline) {
                analysisHTML += `<div class="status warning">‚ö†Ô∏è Contains 'unsafe-inline' - Should use nonce instead</div>`;
                log('WARNING: CSP contains unsafe-inline', 'warning');
            } else {
                analysisHTML += `<div class="status success">‚úÖ No 'unsafe-inline' found</div>`;
                log('GOOD: No unsafe-inline found', 'success');
            }

            if (hasNonce) {
                analysisHTML += `<div class="status success">‚úÖ Uses nonce-based approach</div>`;
                log('GOOD: Uses nonce-based approach', 'success');
            } else {
                analysisHTML += `<div class="status warning">‚ö†Ô∏è No nonce-based approach detected</div>`;
                log('WARNING: No nonce-based approach detected', 'warning');
            }

            analysisHTML += '</div>';
            document.getElementById('csp-analysis').innerHTML = analysisHTML;

            // Calculate security score
            let score = 100;
            if (hasUnsafeEval) score -= 30;
            if (hasUnsafeInline) score -= 15;
            if (!hasNonce) score -= 10;
            
            let scoreClass = 'score-excellent';
            let scoreMessage = 'Excellent Security';
            
            if (score < 70) {
                scoreClass = 'score-critical';
                scoreMessage = 'Critical Issues';
            } else if (score < 80) {
                scoreClass = 'score-warning';
                scoreMessage = 'Needs Improvement';
            } else if (score < 90) {
                scoreClass = 'score-good';
                scoreMessage = 'Good Security';
            }

            const scoreHTML = `
                <div class="validation-score ${scoreClass}">
                    Security Score: ${score}/100<br>
                    <span style="font-size: 16px;">${scoreMessage}</span>
                </div>
            `;
            
            document.getElementById('validation-results').innerHTML = scoreHTML;
            log(`Security score calculated: ${score}/100`, 'success');
        }

        // Security Tests
        function runSecurityTests() {
            log('Running security tests...');
            document.getElementById('security-tests').innerHTML = '';

            // Test 1: Check for unsafe-eval
            const cspMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
            const cspContent = cspMeta ? cspMeta.getAttribute('content') : '';
            const hasUnsafeEval = cspContent.includes("'unsafe-eval'");
            addTestResult('security-tests', 'Unsafe Eval Check', !hasUnsafeEval, 
                hasUnsafeEval ? 'Found unsafe-eval directive' : 'No unsafe-eval found');

            // Test 2: Check for unsafe-inline
            const hasUnsafeInline = cspContent.includes("'unsafe-inline'");
            addTestResult('security-tests', 'Unsafe Inline Check', !hasUnsafeInline,
                hasUnsafeInline ? 'Found unsafe-inline directive' : 'No unsafe-inline found');

            // Test 3: Check for nonce usage
            const hasNonce = cspContent.includes("'nonce-");
            addTestResult('security-tests', 'Nonce Usage Check', hasNonce,
                hasNonce ? 'Nonce-based CSP detected' : 'No nonce-based CSP found');

            // Test 4: Check for essential security directives
            const essentialDirectives = [
                { name: 'object-src none', check: cspContent.includes("object-src 'none'") },
                { name: 'frame-ancestors none', check: cspContent.includes("frame-ancestors 'none'") },
                { name: 'upgrade-insecure-requests', check: cspContent.includes('upgrade-insecure-requests') }
            ];

            essentialDirectives.forEach(dir => {
                addTestResult('security-tests', dir.name, dir.check,
                    dir.check ? 'Directive present' : 'Directive missing');
            });

            log('Security tests completed');
        }

        // Functionality Tests
        function runFunctionalityTests() {
            log('Running functionality tests...');
            document.getElementById('functionality-tests').innerHTML = '';

            // Test 1: Check if styled-components can inject styles
            const styledElements = document.querySelectorAll('style[data-styled-components]');
            const hasStyledComponents = styledElements.length > 0;
            addTestResult('functionality-tests', 'Styled Components', hasStyledComponents,
                hasStyledComponents ? `${styledElements.length} styled elements found` : 'No styled elements found');

            // Test 2: Check nonce meta tag
            const nonceMeta = document.querySelector('meta[name="csp-nonce"]');
            const hasNonceMeta = nonceMeta !== null;
            const nonceValue = hasNonceMeta ? nonceMeta.getAttribute('content') : 'none';
            addTestResult('functionality-tests', 'Nonce Meta Tag', hasNonceMeta,
                hasNonceMeta ? `Nonce: ${nonceValue}` : 'No nonce meta tag');

            // Test 3: Check if scripts can run with nonce
            let scriptTestPassed = false;
            try {
                // This will be tested by interactive test
                scriptTestPassed = true;
            } catch (e) {
                scriptTestPassed = false;
            }
            addTestResult('functionality-tests', 'Script Execution', scriptTestPassed,
                'Will be tested interactively');

            log('Functionality tests completed');
        }

        // Interactive Tests
        function testInlineScript() {
            log('Testing inline script execution...');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pending';
            resultDiv.innerHTML = '<strong>Inline Script Test:</strong> Testing...';
            interactiveResults.appendChild(resultDiv);

            try {
                // Try to execute inline script
                const testResult = 'Inline script executed successfully';
                resultDiv.className = 'test-result pass';
                resultDiv.innerHTML = `<strong>Inline Script Test:</strong> ‚úÖ PASS - ${testResult}`;
                log('Inline script test: PASS', 'success');
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.innerHTML = `<strong>Inline Script Test:</strong> ‚ùå FAIL - ${error.message}`;
                log(`Inline script test: FAIL - ${error.message}`, 'error');
            }
        }

        function testInlineStyle() {
            log('Testing inline style application...');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pending';
            resultDiv.innerHTML = '<strong>Inline Style Test:</strong> Testing...';
            interactiveResults.appendChild(resultDiv);

            try {
                // Try to apply inline style
                const testElement = document.createElement('div');
                testElement.style.color = 'red';
                testElement.textContent = 'Test element with inline style';
                document.body.appendChild(testElement);
                
                resultDiv.className = 'test-result pass';
                resultDiv.innerHTML = '<strong>Inline Style Test:</strong> ‚úÖ PASS - Inline style applied successfully';
                log('Inline style test: PASS', 'success');
                
                // Clean up
                setTimeout(() => document.body.removeChild(testElement), 2000);
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.innerHTML = `<strong>Inline Style Test:</strong> ‚ùå FAIL - ${error.message}`;
                log(`Inline style test: FAIL - ${error.message}`, 'error');
            }
        }

        function testEval() {
            log('Testing eval() function...');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pending';
            resultDiv.innerHTML = '<strong>Eval Test:</strong> Testing...';
            interactiveResults.appendChild(resultDiv);

            try {
                // Try to use eval
                const result = eval('2 + 2');
                resultDiv.className = 'test-result pass';
                resultDiv.innerHTML = `<strong>Eval Test:</strong> ‚ùå FAIL - Eval executed (should be blocked)`;
                log('Eval test: FAIL - Eval should be blocked by CSP', 'error');
            } catch (error) {
                resultDiv.className = 'test-result pass';
                resultDiv.innerHTML = `<strong>Eval Test:</strong> ‚úÖ PASS - Eval blocked by CSP`;
                log('Eval test: PASS - Eval correctly blocked', 'success');
            }
        }

        function testExternalResource() {
            log('Testing external resource loading...');
            const resultDiv = document.createElement('div');
            resultDiv.className = 'test-result pending';
            resultDiv.innerHTML = '<strong>External Resource Test:</strong> Testing...';
            interactiveResults.appendChild(resultDiv);

            try {
                // Try to load external script
                const script = document.createElement('script');
                script.src = 'https://unpkg.com/lodash@4.17.21/lodash.min.js';
                script.onload = () => {
                    resultDiv.className = 'test-result pass';
                    resultDiv.innerHTML = '<strong>External Resource Test:</strong> ‚úÖ PASS - External resource loaded';
                    log('External resource test: PASS', 'success');
                };
                script.onerror = () => {
                    resultDiv.className = 'test-result fail';
                    resultDiv.innerHTML = '<strong>External Resource Test:</strong> ‚ùå FAIL - External resource blocked';
                    log('External resource test: FAIL - Resource blocked', 'error');
                };
                document.head.appendChild(script);
            } catch (error) {
                resultDiv.className = 'test-result fail';
                resultDiv.innerHTML = `<strong>External Resource Test:</strong> ‚ùå FAIL - ${error.message}`;
                log(`External resource test: FAIL - ${error.message}`, 'error');
            }
        }

        function runAllTests() {
            log('Running all tests...');
            interactiveResults.innerHTML = '';
            
            testInlineScript();
            setTimeout(() => testInlineStyle(), 500);
            setTimeout(() => testEval(), 1000);
            setTimeout(() => testExternalResource(), 1500);
        }

        // Initialize tests on page load
        window.addEventListener('load', () => {
            log('Page loaded, starting tests...');
            
            setTimeout(() => {
                analyzeCSP();
                runSecurityTests();
                runFunctionalityTests();
                log('All tests completed');
            }, 1000);
        });

        // Listen for CSP violations
        document.addEventListener('securitypolicyviolation', (event) => {
            log(`CSP Violation: ${event.violatedDirective} - ${event.blockedURI}`, 'error');
            
            const violationDiv = document.createElement('div');
            violationDiv.className = 'status error';
            violationDiv.innerHTML = `
                üö® CSP Violation Detected:<br>
                <strong>Directive:</strong> ${event.violatedDirective}<br>
                <strong>Blocked URI:</strong> ${event.blockedURI}<br>
                <strong>Source:</strong> ${event.sourceFile || 'unknown'}:${event.lineNumber || 'unknown'}:${event.columnNumber || 'unknown'}
            `;
            
            document.body.insertBefore(violationDiv, document.body.firstChild);
        });
    </script>
</body>
</html>